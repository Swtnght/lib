#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ QOwnNotes –≤ AstraLinux Orel
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: https://github.com/pbek/QOwnNotes

set -e

echo "üîß –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É QOwnNotes –≤ AstraLinux..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
which qmake || { echo "‚ùå qmake –Ω–µ –Ω–∞–π–¥–µ–Ω"; exit 1; }
which make || { echo "‚ùå make –Ω–µ –Ω–∞–π–¥–µ–Ω"; exit 1; }
which git || { echo "‚ùå git –Ω–µ –Ω–∞–π–¥–µ–Ω"; exit 1; }

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Qt
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Qt..."
qmake -query QT_VERSION

# –û–±–Ω–æ–≤–ª—è–µ–º git submodules –µ—Å–ª–∏ –µ—Å—Ç—å
if [ -f ".gitmodules" ]; then
    echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ git submodules..."
    git submodule update --init --recursive
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é src
cd src

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .pro —Ñ–∞–π–ª–∞
if [ ! -f "QOwnNotes.pro" ]; then
    echo "‚ùå QOwnNotes.pro –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ src/"
    exit 1
fi

echo "‚úÖ QOwnNotes.pro –Ω–∞–π–¥–µ–Ω"

# –°–±–æ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
if [ "$ENABLE_TRANSLATIONS" = "true" ]; then
    echo "üåê –°–±–æ—Ä–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤..."
    lrelease QOwnNotes.pro
fi

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–±–æ—Ä–∫–∏
echo "üî® –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–±–æ—Ä–∫–∏..."
qmake QOwnNotes.pro

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ QOwnNotes..."
make -j${PARALLEL_JOBS:-4}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
if [ -f "QOwnNotes" ]; then
    echo "‚úÖ QOwnNotes —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"
    ls -la QOwnNotes
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ QOwnNotes"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if [ "$INSTALL_APP" = "true" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ QOwnNotes..."
    make install
fi

echo "üéâ –°–±–æ—Ä–∫–∞ QOwnNotes –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!" 